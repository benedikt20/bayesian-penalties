---
title: "SDS 6540 Final Project"
author: "Benedikt Farag"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
    toc-depth: 5
    number-sections: true
    toc-expand: true    # replaces "toc_float"
    self-contained: true
  pdf:
    documentclass: article
    geometry: margin=1in
urlcolor: magenta
---

```{r}
library(dplyr)
library(tidyr)
library(brms)
library(ggplot2)
library(gganimate)

# make gifs directory to save animations
if (!dir.exists("gifs")) {
  dir.create("gifs")
}

```

# Load data

```{r}
data <- read.csv("data/penalties_scraped_corrected.csv")

# load model
model <- readRDS("models/mn-model_keeper_taker.rds")

# remove rows with outcome as 'Wayward' (invalid penalties)
data <- data %>%
  filter(outcome != "Wayward")

rpost <- 3.66    # right post x-coordinate
lpost <- -rpost  # left post x-coordinate
bar <- 2.44      # crossbar z-coordinate
delta <- 0.12    # goal frame thickness

Y_POINTS <- 100  # number of points along y axis
Z_POINTS <- 50   # number of points along z axis

gif_ndraws <- 100  # number of posterior draws to sample for gif

```



```{r}
goal_grid <- expand.grid(
  y_end = seq(lpost - 2*delta, rpost + 2*delta, length.out = Y_POINTS),
  z_end = seq(0, bar + 2*delta, length.out = Z_POINTS)
)

posterior_draws <- fitted(
  model,
  newdata = goal_grid,
  summary = FALSE,
  re_formula = NA # exclude random effects
)
```


```{r}
draw_indices <- sample(nrow(posterior_draws), gif_ndraws)

anim_data <- posterior_draws[draw_indices, , "Goal"] %>%
  as.data.frame() %>%
  mutate(.draw = 1:gif_ndraws) %>%
  pivot_longer(
    cols = -c(.draw), 
    names_to = "grid_id", 
    values_to = "prob_goal"
  ) %>%
  # The grid_id is 'V1', 'V2', etc. - convert to integer
  mutate(grid_id = as.integer(gsub("V", "", grid_id))) %>%
  left_join(
    mutate(goal_grid, grid_id = 1:nrow(goal_grid)),
    by = "grid_id"
  )
```


```{r}
# Create the animated plot
p_anim <- ggplot(anim_data, aes(x = y_end, y = z_end)) +
  geom_raster(aes(fill = prob_goal)) +
  scale_fill_gradientn(
    colours = c("blue", "cyan", "yellow", "red"),
    name = "P(Goal)",
    limits = c(0, 1)
  ) +
  # goal frame
  geom_rect(
    aes(xmin = lpost, xmax = rpost, ymin = 0, ymax = bar), 
    fill = "transparent", color = "black", linewidth = 0.3) +
  geom_rect(
    xmin = lpost - delta, xmax = rpost + delta, ymin = 0, ymax = bar + delta,
    fill = "transparent", color = "black", linewidth = 0.3) +
  theme_test() + 
  coord_fixed(ratio = 1) +

  # let gganimate make .draw the animation frame
  transition_states(
    .draw,
    transition_length = 1, 
    state_length = 1
  ) +
  ease_aes('cubic-in-out') + # Smooths the transition
  labs(
    title = paste0("Posterior P(Goal): {closest_state} of ", gif_ndraws, " Samples")
  ) +
  coord_fixed(ratio = 1) +
  # set ticks and axis names
  scale_x_continuous(
    name = "y (meters)",
    limits = c(lpost - 2*delta, rpost + 2*delta),
    breaks = c(lpost, -3, -2, -1, 0, 1, 2, 3, rpost) 
  ) +
  scale_y_continuous(
    name = "z (meters)",
    limits = c(0, bar + 2*delta),
    breaks = c(0, 0.5, 1, 1.5, 2, 2.5, 3) 
  )

# render the gif
animate(
  p_anim, 
  nframes = 100, 
  fps = 10, 
  width = 800, 
  height = 500,
  renderer = gifski_renderer("gifs/posterior_draws.gif")
)
```